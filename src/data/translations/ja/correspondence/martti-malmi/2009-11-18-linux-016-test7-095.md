---
title: "返信: linux-0.1.6-test7"
date: 2009-11-18T04:35:32Z
source: correspondence
sourceUrl: "https://mmalmi.github.io/satoshi/"
author: "Satoshi Nakamoto"
participants:
  - name: "Satoshi Nakamoto"
    slug: "satoshi-nakamoto"
  - name: "Martti Malmi"
    slug: "martti-malmi"
description: "やっと簡単な問題です。初期ダウンロードのような長い操作中に発生しうる原因が見えました。"
isSatoshi: true
threadId: "satoshi-martti-malmi"
threadTitle: "Satoshi ↔ Martti Malmi Correspondence"
threadPosition: 95
tags:
  - "correspondence"
  - "early-contributor"
  - "linux"
secondarySources:
  - name: "Martti Malmi's Published Email Archive"
    url: "https://mmalmi.github.io/satoshi/"
  - name: "COPA v. Wright Trial Exhibits"
    url: "https://www.opencrypto.org/2024-02-22-witnesses-satoshi-correspondence/"
translationStatus: complete
---

やっと簡単な問題です。初期ダウンロードのような長い操作中に発生しうる原因が見えました。TryLockのバグはDB関連の問題とは無関係です。修正はtest8に含まれます。

32ビットLinux上で、絶え間ないリクエストの連続フラッドを送りつけることで、db::open/close例外を3回再現できました。wallet.datデータベースを定期的に閉じてフラッシュするだけでもdb::close例外が発生するようです。Linuxではウォレットフラッシュ機能を無効にします。Linux上では、終了する準備ができるまでデータベースハンドルを閉じないようにします。これを無効にしてからは、今のところ例外は発生していません。

初期ブロックダウンロードの秩序立った実装も進めています。すべてのブロックを一度にリクエストする素朴な方法ではなく、一度に500件ずつバッチでリクエストするようにします。こうすることで、リトライタイムアウトの前にブロックを受信できるため、実際に受信できなかったり遅すぎたりしない限り、他のノードにリクエストすることはなくなるはずです。変更はリクエストを受ける側にあるため、初期ブロックダウンロードの相手が新しいバージョンのノードになるまで、この機能は見えません。

test8を送る前にもう少しテストを続けます。

Liberty Standard の書き込み：
> test7で新しいデータディレクトリから開始しました。ブロックのダウンロードがずっと速くなりました。Linuxビルドでは以前数分かかっていたところ、約15秒しかかかりませんでした。ブロックのダウンロード中に以下のメッセージがターミナルに表示されて一度クラッシュしました。
>
> ../include/wx/thrimpl.cpp(50): assert "m_internal" failed in TryLock():
> wxMutex::TryLock(): not initialized [in child thread]
> Trace/breakpoint trap
>
> ログファイルを添付しましたが、bitcoinを再起動する前にバックアップするのを忘れたため、ログファイルのどの時点でクラッシュしたかわかりません。
>
> 幸い、まだセグメンテーションフォルトには遭遇していません。以前のビルドではセグメンテーションフォルトの頻度がかなりばらつきがあったので、引き続き実行して問題があればお知らせします。
>
>
>
> 2009年11月17日(火) 午前5:41、Satoshi Nakamoto <satoshin@gmx.com
> <mailto:satoshin@gmx.com>> の書き込み：
>
>     test 7：
>
>     念のため、実行前にデータディレクトリをバックアップしてください。
>
>     Db::open/Db::close「Bad file descriptor」例外の回避策です。
>     初期ブロックダウンロードも高速化される可能性があります。回避策は、
>     データベースハンドルを開いたままプログラムの実行中ずっと保持しておくことで、
>     実際これはより一般的なやり方でもあります。常に閉じたり開いたりしなければ、
>     エラーが発生する機会がなくなるはずです。
>
>     唯一の例外はwallet.datで、書き込み完了後にトランザクションログを
>     datファイルにフラッシュするために閉じるようにしています。これにより、
>     datファイルが単体で有効になります。Bitcoinの実行中に誰かがバックアップを
>     取った場合、データベースのトランザクションログなしでもそれ自体で
>     有効なwallet.datを取得できます。
>
>     これはデータベース処理の再構成なので、新たなデッドロックが
>     見つかるかもしれません。通常、デッドロックが発生すると、UIの再描画が
>     止まるか、まだGeneratingと表示されているにもかかわらずCPUを
>     使用しなくなります。
>
>

*出典：COPA対Wright裁判の証言の一環として、2024年2月にMartti MalmiによりGitHubで公開。完全な書簡アーカイブはmmalmi.github.io/satoshi/で閲覧可能。*
